#!/usr/bin/env fish

# Verificar que estamos en un repositorio Git
git rev-parse --is-inside-work-tree >/dev/null 2>&1
if test $status -ne 0
    echo "‚ùå Error: No est√°s en un repositorio Git."
    exit 1
end

# Mostrar la rama actual
set branch (git rev-parse --abbrev-ref HEAD)
echo "üåø Rama actual: $branch"

# Comprobar si hay upstream configurado
if not git rev-parse --abbrev-ref "@{u}" >/dev/null 2>&1
    echo "‚öôÔ∏è  No hay remoto configurado. Solo se har√°n commits locales."
    set has_remote 0
else
    set has_remote 1
end

# Actualizar refs remotas (si hay)
if test $has_remote -eq 1
    echo "üîÑ Comprobando estado del remoto..."
    git fetch >/dev/null 2>&1
end

# Obtener commits si hay remoto
if test $has_remote -eq 1
    set local_commit (git rev-parse @)
    set remote_commit (git rev-parse "@{u}" 2>/dev/null)
    set base_commit (git merge-base @ "@{u}" 2>/dev/null)

    if test -z "$remote_commit"
        echo "‚öôÔ∏è  No se pudo obtener informaci√≥n remota. Revisa la conexi√≥n."
    else if test "$local_commit" = "$remote_commit"
        echo "üü¢ Local y remoto est√°n sincronizados."
    else if test "$local_commit" = "$base_commit"
        echo "‚¨áÔ∏è  Hay cambios en remoto, haciendo pull..."
        git pull --rebase
    else if test "$remote_commit" = "$base_commit"
        echo "‚¨ÜÔ∏è  Hay cambios locales, listos para subir."
    else
        echo "‚ö†Ô∏è  Tu rama y el remoto han divergido. Revisa manualmente (rebase/merge)."
        echo ""
        echo "√öltimo commit local:"
        git log -1 --oneline @
        echo "√öltimo commit remoto:"
        git log -1 --oneline "@{u}"
        exit 1
    end
end

# Comprobar si hay cambios locales
set diff_changed 0
set staged_changed 0
git diff --quiet; or set diff_changed 1
git diff --cached --quiet; or set staged_changed 1

if test "$diff_changed" = 1 -o "$staged_changed" = 1
    read -P "Mensaje del commit (ENTER para 'update'): " commit_message
    if test -z "$commit_message"
        set commit_message "update"
    end

    git add -A
    git commit -m "$commit_message"

    if test $has_remote -eq 1
        git push
        echo "‚úÖ Cambios enviados correctamente."
    else
        echo "‚úÖ Commit local realizado (sin remoto configurado)."
    end
else
    echo "‚ÑπÔ∏è  No hay cambios locales que enviar."
end

